---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Detecting Malware Infection (MITRE ATT\&CK: T1566, T1059)

**Note: On some occasions, hopefully, at a minimum, you will have to customise the queries for your environment. Also, queries will only work if the data is available.**

### **1. Detecting Malware Infection (MITRE ATT\&CK: T1566, T1059)**

#### **Overview:**

Malware infection often involves scripts, executables, and payloads designed to compromise systems, execute commands, or maintain persistence. These infections can lead to lateral movement, data theft, or further compromises within the network.

**Below are 25 Example Queries for Malware Infection Detection:**

1. **Detect Suspicious PowerShell Commands (Encoded Commands)**\
   &#xNAN;_&#x50;owerShell-encoded commands often indicate obfuscation used in malware payloads._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "powershell.exe" and ProcessCommandLine has "encodedCommand" | where InitiatingProcessAccountName !="network service" and InitiatingProcessAccountName !="system"| summarize count() by TimeGenerated, DeviceName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

**Note: The following is an example of how to decode PowerShell-encoded commands:**

{% code overflow="wrap" %}
```powershell
# Example encoded string
$EncodedCommand = "enter encoded string"

# Convert from Base64 to bytes
$Bytes = [System.Convert]::FromBase64String($EncodedCommand)

# Convert bytes to string (UTF-16 LE)
$DecodedCommand = [System.Text.Encoding]::Unicode.GetString($Bytes)

# Output the decoded command
Write-Output $DecodedCommand
```
{% endcode %}

#### **Method 2: Decode Using Python**

Hereâ€™s how you can decode it using Python:

{% code overflow="wrap" %}
```python
import base64

# Encoded command string
encoded_command = "Enter encoded string"

# Decode the Base64 string
decoded_bytes = base64.b64decode(encoded_command)

# Convert bytes to string (UTF-16 LE)
decoded_command = decoded_bytes.decode("utf-16-le")

# Print the decoded command
print(decoded_command)
```
{% endcode %}

2. **Identify Execution of Suspicious EXEs from Temp Directories**\
   &#xNAN;_&#x4D;alware often resides in temp directories before execution._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName endswith ".exe" and FolderPath contains "Temp" | where InitiatingProcessAccountName !="network service" and InitiatingProcessAccountName !="system" | where  FileName !in~ ("DismHost.exe", "Update.exe") and FolderPath startswith "C:\\Windows\\Temp\\" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

3. **Track Use of MSHTA for Malicious Script Execution**\
   &#xNAN;_&#x4D;SHTA is frequently abused to execute malicious scripts._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "mshta.exe"  | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

4. **Detect Rundll32 Execution of Malicious DLLs**\
   &#xNAN;_&#x52;undll32 is often used to execute malicious DLLs, a common malware technique._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "rundll32.exe" and ProcessCommandLine has ".dll" | where InitiatingProcessAccountName !="network service" and InitiatingProcessAccountName !="system" and InitiatingProcessAccountName !="local service" and InitiatingProcessAccountName !="lokaler dienst"  | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

5. **Monitor Execution of Suspicious Scripting Engines**\
   &#xNAN;_&#x4D;alicious scripts may be executed via WScript or CScript._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName in ("wscript.exe", "cscript.exe") | where InitiatingProcessAccountName !="network service" and InitiatingProcessAccountName !="system" and InitiatingProcessAccountName !="local service" and InitiatingProcessAccountName !="lokaler dienst" and InitiatingProcessAccountName !startswith "sys" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

6. **Track EXE File Downloads and Execution via CertUtil**\
   &#xNAN;_&#x43;ertUtil is often abused to download malware payloads._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "certutil.exe" and ProcessCommandLine has "URL" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

7. **Identify the Use of LOLBins (Living Off the Land Binaries)**\
   &#xNAN;_&#x53;tandard system binaries like bitsadmin and msiexec are often used in attacks._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName in ("bitsadmin.exe", "msiexec.exe") | where InitiatingProcessAccountName !="network service" and InitiatingProcessAccountName !="system" and InitiatingProcessAccountName !="local service" and InitiatingProcessAccountName !="lokaler dienst" and InitiatingProcessAccountName !startswith "sys" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

8. **Detect Creation of Suspicious Scheduled Tasks**\
   &#xNAN;_&#x4D;alware often uses scheduled tasks for persistence._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "schtasks.exe" and ProcessCommandLine has "create" | where InitiatingProcessAccountName !="system" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

9. **Monitor PowerShell Script Downloads via Invoke-WebRequest**\
   &#xNAN;_&#x49;nvoke-WebRequest is used to download malicious scripts from the internet._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "powershell.exe" and ProcessCommandLine has "Invoke-WebRequest" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

10. **Track Suspicious Use of Bitsadmin for File Transfers**\
    &#xNAN;_&#x42;itsadmin is sometimes leveraged to download or upload malicious files._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "bitsadmin.exe" and ProcessCommandLine has "transfer" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine
```
{% endcode %}

11. **Detect New EXE Files in User Directories**\
    &#xNAN;_&#x4E;ew EXE files appearing in user directories may indicate malware delivery._

{% code overflow="wrap" %}
```kusto
DeviceFileEvents | where FileName endswith ".exe" and FolderPath contains "Users" | where InitiatingProcessAccountName != "system"| summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, FolderPath
```
{% endcode %}

12. **Monitor Process Spawning from Office Applications**\
    &#xNAN;_&#x4D;alicious macros in Office documents may spawn child processes._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where InitiatingProcessFileName in ("winword.exe", "excel.exe", "powerpnt.exe")| summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, FolderPath
```
{% endcode %}

13. **Detect the Use of Task Scheduler to Maintain Persistence**\
    &#xNAN;_&#x53;cheduled tasks can be created by malware to ensure persistence._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName == "schtasks.exe" and ProcessCommandLine has_any ("create", "add") | where InitiatingProcessAccountName != "system"| summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

14. **Identify Script Execution via CMD (Batch Scripts)**\
    &#xNAN;_&#x43;MD can be used to execute batch scripts in malware infections._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "cmd.exe" and ProcessCommandLine has_any (".bat", "start") | where InitiatingProcessAccountName != "system" and InitiatingProcessAccountName !startswith "svc-wc" and InitiatingProcessAccountName !startswith "sys_"| summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

15. **Track PowerShell Use of Bypass Execution Policies**\
    &#xNAN;_&#x4D;alicious PowerShell scripts often bypass execution policies._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName == "powershell.exe" and ProcessCommandLine has "-ExecutionPolicy Bypass" | where InitiatingProcessAccountName != "system" and InitiatingProcessAccountName !startswith "sys_" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

16. **Detect DLL Side-Loading or Injection**\
    &#xNAN;_&#x44;LL injection or side-loading is used to execute malicious code within trusted processes._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "rundll32.exe" and ProcessCommandLine has ".dll" | where InitiatingProcessAccountName !="system" and InitiatingProcessAccountName != "lokaler dienst" and InitiatingProcessAccountName != "local service" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

17. **Monitor Unusual Use of MSBuild for Malware Execution**\
    &#xNAN;_&#x4D;SBuild is sometimes leveraged to execute code or load malware._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "MSBuild.exe" | where InitiatingProcessAccountName !startswith "sys_" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

18. **Detect Use of Hidden Windows for Malware Persistence (explorer.exe)**\
    &#xNAN;_&#x4D;alware can use hidden windows to hide its execution from the user._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName == "explorer.exe" and ProcessCommandLine has "hidden" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

19. **Monitor Suspicious Use of CMD for File Deletion**\
    &#xNAN;_&#x4D;alware may delete files to cover its tracks using the "del" command._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName == "cmd.exe" and ProcessCommandLine has "del" | where InitiatingProcessAccountName != "system" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

20. **Track Use of Remote Desktop Protocol for Malicious Access**\
    &#xNAN;_&#x52;DP is often used to access compromised systems remotely._

{% code overflow="wrap" %}
```kusto
DeviceLogonEvents | where LogonType == "RemoteInteractive" and ActionType == "LogonSuccess" | where AccountName !startswith "sys_" | summarize count() by AccountName, DeviceName, RemoteIP, IsLocalAdmin, LogonType, ActionType, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath
```
{% endcode %}

21. **Detect Powershell Execution Using Uncommon Flags**\
    &#xNAN;_&#x4D;alicious scripts may use uncommon flags to bypass detection (e.g., -windowstyle hidden)._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "powershell.exe" and ProcessCommandLine has "-windowstyle hidden" | where InitiatingProcessAccountName != "system" and InitiatingProcessAccountName != "network service"| summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

22. **Monitor the Use of VSSAdmin for Shadow Copy Deletion**\
    &#xNAN;_&#x4D;alware (such as ransomware) may delete volume shadow copies to prevent recovery._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName == "vssadmin.exe" and ProcessCommandLine has "delete shadows" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath
```
{% endcode %}

23. **Identify Unusual Network Traffic from Newly Executed Binaries**\
    &#xNAN;_&#x4D;alware often communicates with external C2 servers after execution._

{% code overflow="wrap" %}
```kusto
DeviceNetworkEvents | where InitiatingProcessFileName endswith ".exe" and RemoteUrl != "" | where InitiatingProcessAccountName != "system" and InitiatingProcessAccountName != "network service" and InitiatingProcessAccountName != "lokaler dienst" and InitiatingProcessAccountName != "netzwerkdienst" | summarize count() by DeviceName, ActionType, RemoteIP, LocalIP, RemotePort, RemoteUrl, InitiatingProcessAccountName, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessParentFileName
```
{% endcode %}

24. **Detect Execution of Signed Binaries Used by Attackers**\
    &#xNAN;_&#x41;ttackers may abuse trusted signed binaries for malicious purposes (e.g., regsvr32, msiexec)._

{% code overflow="wrap" %}
```cs
DeviceProcessEvents | where FileName in ("regsvr32.exe", "msiexec.exe") | where InitiatingProcessAccountName != "system" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath, InitiatingProcessFolderPath
```
{% endcode %}

25. **Monitor the Use of Certutil for Decoding Malicious Payloads**\
    &#xNAN;_&#x43;ertutil can be used to decode base64-encoded malicious payloads._

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents | where FileName == "certutil.exe" and ProcessCommandLine has "decode" | summarize count() by TimeGenerated, DeviceName, FileName, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, FolderPath, InitiatingProcessFolderPath
```
{% endcode %}
