# Malware Attack Investigation Runbook

### SOC & DFIR Operations Guide

**Environment:** Windows AD | Microsoft 365 | Defender XDR | Sentinel | Entra ID | Palo Alto Prisma Access

***

## Overview & Scope

This runbook provides standardised procedures for investigating malware-based attacks across the hybrid enterprise environment. It covers detection, triage, investigation, containment, eradication, and recovery workflows using Microsoft Defender XDR, Sentinel, and Palo Alto Prisma Access.

### Malware Categories

| Category             | Description                                   | Common Examples                    |
| -------------------- | --------------------------------------------- | ---------------------------------- |
| **Ransomware**       | Encrypts files, demands payment               | LockBit, BlackCat, Cl0p, Play      |
| **Trojans**          | Disguised malicious software                  | Emotet, TrickBot, QakBot           |
| **RATs**             | Remote Access Trojans for persistent access   | Cobalt Strike, AsyncRAT, RemcosRAT |
| **Infostealers**     | Credential and data theft                     | RedLine, Raccoon, Vidar, Lumma     |
| **Loaders/Droppers** | Initial access, downloads additional payloads | IcedID, BumbleBee, Gootloader      |
| **Rootkits**         | Deep system persistence, evasion              | BlackLotus, various bootkits       |
| **Fileless Malware** | Memory-resident, LOLBins abuse                | PowerShell-based, WMI persistence  |
| **Worms**            | Self-propagating network threats              | Various SMB/network worms          |
| **Cryptominers**     | Unauthorized cryptocurrency mining            | XMRig variants                     |
| **Wipers**           | Data destruction                              | HermeticWiper, CaddyWiper          |

### Common Attack Vectors

<table><thead><tr><th width="212">Vector</th><th>Description</th><th>Primary Detection</th></tr></thead><tbody><tr><td><strong>Phishing Emails</strong></td><td>Malicious attachments/links</td><td>MDO, EmailEvents</td></tr><tr><td><strong>Drive-by Downloads</strong></td><td>Compromised websites</td><td>MDE, Prisma URL filtering</td></tr><tr><td><strong>Supply Chain</strong></td><td>Compromised software updates</td><td>MDE, application allow-listing</td></tr><tr><td><strong>Removable Media</strong></td><td>USB-based infection</td><td>MDE, DeviceEvents</td></tr><tr><td><strong>Exploitation</strong></td><td>Vulnerability exploitation</td><td>MDE, DeviceEvents</td></tr><tr><td><strong>Malvertising</strong></td><td>Malicious advertisements</td><td>Prisma Access, MDE</td></tr><tr><td><strong>Social Engineering</strong></td><td>User manipulation</td><td>MDO, user reporting</td></tr></tbody></table>

***

## Detection Sources & Data Mapping

### Log Sources Matrix

<table><thead><tr><th width="207">Platform</th><th width="248">Log Table</th><th>Key Data</th></tr></thead><tbody><tr><td>Defender for Endpoint</td><td><code>DeviceEvents</code></td><td>Process creation, file operations, registry</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceProcessEvents</code></td><td>Process execution, command lines</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceNetworkEvents</code></td><td>Network connections, DNS queries</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceFileEvents</code></td><td>File creation, modification, deletion</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceRegistryEvents</code></td><td>Registry modifications</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceImageLoadEvents</code></td><td>DLL loads, driver loads</td></tr><tr><td>Defender for Endpoint</td><td><code>DeviceLogonEvents</code></td><td>Authentication events</td></tr><tr><td>Defender for Endpoint</td><td><code>AlertInfo</code>, <code>AlertEvidence</code></td><td>Correlated alerts and evidence</td></tr><tr><td>Defender for Office</td><td><code>EmailEvents</code>, <code>EmailAttachmentInfo</code></td><td>Email metadata, attachments</td></tr><tr><td>Defender for Office</td><td><code>EmailUrlInfo</code>, <code>UrlClickEvents</code></td><td>URLs in emails, click tracking</td></tr><tr><td>Sentinel</td><td><code>SecurityAlert</code></td><td>Aggregated alerts from all sources</td></tr><tr><td>Sentinel</td><td><code>ThreatIntelligenceIndicator</code></td><td>IOC matches</td></tr><tr><td>Prisma Access</td><td><code>PaloAltoPrismaAccess</code></td><td>Network threats, URL categories</td></tr></tbody></table>

### Critical MDE Alert Categories

<table><thead><tr><th width="201">Alert Category</th><th>Description</th><th>Severity</th></tr></thead><tbody><tr><td><strong>Malware</strong></td><td>Known malware detected</td><td>High-Critical</td></tr><tr><td><strong>Ransomware</strong></td><td>Ransomware behavior detected</td><td>Critical</td></tr><tr><td><strong>Suspicious activity</strong></td><td>Anomalous behavior patterns</td><td>Medium-High</td></tr><tr><td><strong>Unwanted software</strong></td><td>PUPs, adware, tools</td><td>Low-Medium</td></tr><tr><td><strong>Exploit</strong></td><td>Exploitation attempt detected</td><td>High-Critical</td></tr><tr><td><strong>Persistence</strong></td><td>Persistence mechanism detected</td><td>Medium-High</td></tr><tr><td><strong>Lateral movement</strong></td><td>Movement between systems</td><td>High</td></tr><tr><td><strong>Command and control</strong></td><td>C2 communication detected</td><td>High-Critical</td></tr><tr><td><strong>Exfiltration</strong></td><td>Data theft indicators</td><td>Critical</td></tr><tr><td><strong>Defense evasion</strong></td><td>Security tool tampering</td><td>High</td></tr></tbody></table>

***

## Investigation Workflows

### Malware Alert Triage

**Objective:** Quickly assess alert validity, determine scope, and prioritise response.

#### Step 1: Initial Alert Assessment

1. Review alert in Defender XDR incident queue
2. Check alert severity, category, and detection source
3. Identify affected device(s) and user(s)
4. Review MITRE ATT\&CK techniques mapped to alert
5. Check if alert is part of larger incident (auto-correlated)

#### Step 2: Validate Detection

1. Review the specific file/process that triggered alert
2. Check file hash against VirusTotal and internal threat intel
3. Review file metadata: signer, compilation time, path
4. Examine parent-child process relationships
5. Determine if activity is expected (false positive check)

#### Step 3: Scope Assessment

1. Search for same IOCs across all endpoints
2. Check if other devices have similar alerts
3. Review user's recent email for delivery vector
4. Check network logs for related C2 traffic
5. Identify patient zero and initial access timeline

#### Step 4: Risk Classification

| Risk Level      | Criteria                                          | Action                     |
| --------------- | ------------------------------------------------- | -------------------------- |
| üî¥ **Critical** | Ransomware, active C2, domain admin compromise    | Immediate isolation        |
| üü† **High**     | Confirmed malware, lateral movement, data staging | Isolate within 30 min      |
| üü° **Medium**   | Suspicious activity, potential malware            | Investigate within 4 hours |
| üü¢ **Low**      | PUP, adware, likely false positive                | Next business day          |

***

### Ransomware Investigation

**Objective:** Contain ransomware spread, identify scope, preserve evidence, and enable recovery.

#### Immediate Actions (First 15 Minutes)

1. **Isolate affected devices** via MDE device isolation
2. **Disable compromised accounts** if credentials suspected stolen
3. **Block known IOCs** at network perimeter (Prisma Access)
4. **Alert incident response team** and leadership
5. **Preserve volatile evidence** if possible

#### Step 1: Identify Ransomware Variant

1. Review ransom note filename and content
2. Check encrypted file extension
3. Submit sample to threat intel platforms
4. Identify known decryptors if available
5. Document ransomware family and known TTPs

#### Step 2: Determine Patient Zero

1. Query earliest file encryption events across environment
2. Identify initial infected device by timestamp
3. Review device timeline for initial access vector
4. Check email logs for phishing delivery
5. Examine network logs for exploitation attempts

#### Step 3: Map Lateral Movement

1. Query authentication events from patient zero
2. Identify all accessed systems and shares
3. Check for credential harvesting tools (Mimikatz, etc.)
4. Review network connections to other endpoints
5. Document full scope of compromise

#### Step 4: Identify Data Exfiltration

1. Check for large data transfers before encryption
2. Review cloud storage uploads (OneDrive, SharePoint)
3. Examine network traffic to unknown external IPs
4. Check for staging directories
5. Identify potentially exfiltrated data types

#### Step 5: Containment & Eradication

1. Extend isolation to all affected devices
2. Block all identified C2 infrastructure
3. Reset credentials for affected users
4. Remove persistence mechanisms
5. Scan and clean all affected systems

***

### Fileless Malware Investigation

**Objective:** Detect and investigate memory-resident and LOLBin-based malware.

#### Detection Indicators

* PowerShell with encoded commands (-enc, -e, -encodedcommand)
* WMI/CIM for execution or persistence
* Unusual parent-child process relationships
* LOLBAS tool abuse (certutil, mshta, regsvr32, rundll32)
* .NET assembly loading in memory
* Reflective DLL injection
* Process hollowing indicators

#### Investigation Steps

1. Review process command lines for obfuscation
2. Decode Base64/encoded PowerShell commands
3. Analyse script block logging events
4. Check for WMI subscriptions and persistence
5. Review scheduled tasks for suspicious entries
6. Examine registry run keys and startup locations
7. Analyse memory dumps if available

#### Key LOLBins to Monitor

<table><thead><tr><th width="173">Binary</th><th width="282">Malicious Use</th><th>Detection</th></tr></thead><tbody><tr><td><code>powershell.exe</code></td><td>Script execution, download cradles</td><td>Encoded commands, web requests</td></tr><tr><td><code>cmd.exe</code></td><td>Command execution</td><td>Unusual parent, obfuscation</td></tr><tr><td><code>mshta.exe</code></td><td>HTA execution, proxy execution</td><td>Network connections, child processes</td></tr><tr><td><code>certutil.exe</code></td><td>Download files, decode payloads</td><td><code>-urlcache</code>, <code>-decode</code> flags</td></tr><tr><td><code>regsvr32.exe</code></td><td>Proxy execution, COM objects</td><td><code>/s /u /i:</code> parameters</td></tr><tr><td><code>rundll32.exe</code></td><td>DLL execution, proxy</td><td>Unusual DLLs, network activity</td></tr><tr><td><code>wmic.exe</code></td><td>WMI queries, remote execution</td><td><code>/node:</code>, process calls</td></tr><tr><td><code>msiexec.exe</code></td><td>MSI installation from URL</td><td><code>/q /i http://</code></td></tr><tr><td><code>bitsadmin.exe</code></td><td>File downloads</td><td><code>/transfer</code>, <code>/download</code></td></tr><tr><td><code>cscript/wscript</code></td><td>Script execution</td><td>Unusual scripts, network calls</td></tr></tbody></table>

***

### Email-Based Malware Investigation

**Objective:** Investigate malware delivered via email, identify all recipients, and remediate.

#### Step 1: Identify Malicious Email

1. Query EmailEvents for the malicious message
2. Extract sender, subject, recipient(s), and timestamps
3. Identify attachment details or malicious URLs
4. Check if email passed or was caught by MDO
5. Determine delivery status to all recipients

#### Step 2: Recipient Analysis

1. List all recipients of the malicious email
2. Identify who opened/clicked the email
3. Check UrlClickEvents for link interactions
4. Review endpoint alerts for recipients
5. Prioritise users who interacted with content

#### Step 3: Email Artifact Analysis

1. Extract and analyse attachment hashes
2. Submit to sandbox for detonation
3. Review URL reputation and redirects
4. Check for known phishing kit indicators
5. Document all IOCs from email

#### Step 4: Remediation

1. Purge malicious email from all mailboxes
2. Block sender domain/address
3. Add URL/hash to block lists
4. Notify users who received email
5. Reset credentials if any user interacted

***

## KQL Query Cheat Sheet

### Device Process Analysis

#### Suspicious Process Execution

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents
| where Timestamp > ago(24h)
| where FileName in~ ("powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe", "mshta.exe")
| where ProcessCommandLine has_any ("encodedcommand", "-enc", "-e ", "bypass", "hidden", "downloadstring", "iex", "invoke-expression")
| project Timestamp, DeviceName, AccountName, FileName, ProcessCommandLine, InitiatingProcessFileName
| sort by Timestamp desc
```
{% endcode %}

#### Process Tree Analysis

```kusto
let targetDevice = "WORKSTATION01";
let timeRange = 24h;
DeviceProcessEvents
| where Timestamp > ago(timeRange)
| where DeviceName =~ targetDevice
| project Timestamp, DeviceName, FileName, ProcessId, ProcessCommandLine, 
    InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCommandLine
| sort by Timestamp asc
```

#### Encoded PowerShell Detection

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName =~ "powershell.exe"
| where ProcessCommandLine matches regex @"-[eE][nN]?[cC]?\s+[A-Za-z0-9+/=]{50,}"
| extend DecodedCommand = base64_decode_tostring(extract(@"-[eE][nN]?[cC]?\s+([A-Za-z0-9+/=]+)", 1, ProcessCommandLine))
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, DecodedCommand
```
{% endcode %}

***

### Malware Detection Queries

#### New/Rare Executables

```kusto
DeviceFileEvents
| where Timestamp > ago(24h)
| where ActionType == "FileCreated"
| where FileName endswith ".exe" or FileName endswith ".dll"
| where FolderPath has_any ("temp", "appdata", "programdata", "users\\public")
| summarize 
    FirstSeen = min(Timestamp),
    DeviceCount = dcount(DeviceName),
    Devices = make_set(DeviceName, 10)
    by SHA256, FileName, FolderPath
| where DeviceCount < 3
| sort by FirstSeen desc
```

#### Suspicious File Drops

{% code overflow="wrap" %}
```kusto
DeviceFileEvents
| where Timestamp > ago(24h)
| where ActionType == "FileCreated"
| where InitiatingProcessFileName in~ ("outlook.exe", "winword.exe", "excel.exe", "powerpnt.exe", "chrome.exe", "msedge.exe", "firefox.exe")
| where FileName endswith ".exe" or FileName endswith ".dll" or FileName endswith ".scr" or FileName endswith ".ps1" or FileName endswith ".vbs" or FileName endswith ".js" or FileName endswith ".hta"
| project Timestamp, DeviceName, InitiatingProcessFileName, FileName, FolderPath, SHA256
```
{% endcode %}

#### Ransomware Behaviour Detection

```kusto
DeviceFileEvents
| where Timestamp > ago(1h)
| where ActionType == "FileModified" or ActionType == "FileRenamed"
| summarize 
    ModifiedCount = count(),
    UniqueExtensions = dcount(FileName),
    Extensions = make_set(tostring(split(FileName, ".")[-1]), 20)
    by DeviceName, InitiatingProcessFileName, bin(Timestamp, 5m)
| where ModifiedCount > 100
| sort by ModifiedCount desc
```

***

### Network & C2 Detection

#### Suspicious Outbound Connections

{% code overflow="wrap" %}
```kusto
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where ActionType == "ConnectionSuccess"
| where RemoteIPType == "Public"
| where InitiatingProcessFileName !in~ ("chrome.exe", "msedge.exe", "firefox.exe", "teams.exe", "outlook.exe", "onedrive.exe")
| summarize 
    ConnectionCount = count(),
    BytesSent = sum(SentBytes),
    BytesReceived = sum(ReceivedBytes),
    RemoteIPs = make_set(RemoteIP, 10)
    by DeviceName, InitiatingProcessFileName, RemotePort
| where ConnectionCount > 10
| sort by ConnectionCount desc
```
{% endcode %}

#### Beaconing Detection

{% code overflow="wrap" %}
```kusto
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where ActionType == "ConnectionSuccess"
| where RemoteIPType == "Public"
| summarize 
    ConnectionCount = count(),
    ConnectionTimes = make_list(Timestamp, 1000)
    by DeviceName, InitiatingProcessFileName, RemoteIP, RemotePort
| where ConnectionCount > 20
| extend TimeDeltas = series_diff(array_sort_asc(ConnectionTimes), 1)
| extend AvgDelta = avgif(TimeDeltas, isnotnull(TimeDeltas))
| extend StdDevDelta = stdevif(TimeDeltas, isnotnull(TimeDeltas))
| where StdDevDelta < 60000 // Low variance = potential beaconing (in milliseconds)
| project DeviceName, InitiatingProcessFileName, RemoteIP, RemotePort, ConnectionCount, AvgDelta, StdDevDelta
```
{% endcode %}

#### DNS Anomaly Detection

{% code overflow="wrap" %}
```kusto
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where ActionType == "DnsQueryResponse"
| where RemoteUrl !endswith ".microsoft.com" and RemoteUrl !endswith ".windows.com"
| extend DomainLength = strlen(RemoteUrl)
| extend Entropy = -sum(dynamic_to_json(array_slice(to_utf8(RemoteUrl), 0, -1)) | mv-expand c to typeof(int) | summarize count() by c | project p = toreal(count_) / DomainLength | summarize sum(p * log2(p)))
| where DomainLength > 50 or Entropy > 4.0
| project Timestamp, DeviceName, RemoteUrl, DomainLength, InitiatingProcessFileName
```
{% endcode %}

***

### Persistence Detection

#### Registry Persistence

{% code overflow="wrap" %}
```kusto
DeviceRegistryEvents
| where Timestamp > ago(24h)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any (
    "CurrentVersion\\Run",
    "CurrentVersion\\RunOnce", 
    "CurrentVersion\\RunServices",
    "Winlogon\\Shell",
    "Winlogon\\Userinit",
    "Environment\\UserInitMprLogonScript")
| project Timestamp, DeviceName, ActionType, RegistryKey, RegistryValueName, RegistryValueData, InitiatingProcessFileName
```
{% endcode %}

#### Scheduled Task Creation

{% code overflow="wrap" %}
```kusto
DeviceEvents
| where Timestamp > ago(24h)
| where ActionType == "ScheduledTaskCreated" or ActionType == "ScheduledTaskUpdated"
| project Timestamp, DeviceName, ActionType, FileName, ProcessCommandLine, InitiatingProcessFileName, InitiatingProcessCommandLine
```
{% endcode %}

#### Service Installation

```kusto
DeviceEvents
| where Timestamp > ago(24h)
| where ActionType == "ServiceInstalled"
| project Timestamp, DeviceName, ActionType, 
    ServiceName = tostring(parse_json(AdditionalFields).ServiceName),
    ServicePath = tostring(parse_json(AdditionalFields).ServicePath),
    InitiatingProcessFileName
| where ServicePath !startswith "C:\\Windows\\System32"
```

#### WMI Persistence

```kusto
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "WmiBindEventFilterToConsumer"
| project Timestamp, DeviceName, 
    FilterName = tostring(parse_json(AdditionalFields).FilterName),
    ConsumerName = tostring(parse_json(AdditionalFields).ConsumerName),
    InitiatingProcessFileName
```

***

### Email Malware Queries

#### Malicious Attachment Hunt

{% code overflow="wrap" %}
```kusto
EmailAttachmentInfo
| where Timestamp > ago(7d)
| where FileType in ("exe", "dll", "scr", "js", "vbs", "hta", "ps1", "bat", "cmd", "msi", "jar")
    or FileName endswith ".iso"
    or FileName endswith ".img"
    or FileName endswith ".vhd"
| join kind=inner EmailEvents on NetworkMessageId
| project Timestamp, SenderFromAddress, RecipientEmailAddress, Subject, FileName, FileType, SHA256
| sort by Timestamp desc
```
{% endcode %}

#### URL Click Analysis

{% code overflow="wrap" %}
```kusto
UrlClickEvents
| where Timestamp > ago(7d)
| where ActionType == "ClickAllowed"
| where Url !startswith "https://microsoft.com" and Url !startswith "https://*.sharepoint.com"
| summarize 
    ClickCount = count(),
    UniqueUsers = dcount(AccountUpn),
    Users = make_set(AccountUpn, 10)
    by Url
| where ClickCount > 5
| sort by ClickCount desc
```
{% endcode %}

#### Emails with Password-Protected Attachments

```kusto
EmailAttachmentInfo
| where Timestamp > ago(7d)
| where FileType in ("zip", "7z", "rar")
| join kind=inner EmailEvents on NetworkMessageId
| where Subject has_any ("password", "pwd", "pass:", "code:", "protected")
    or SenderFromAddress !endswith "@yourdomain.com"
| project Timestamp, SenderFromAddress, RecipientEmailAddress, Subject, FileName
```

***

### Threat Hunting Queries

#### Hunt for Cobalt Strike Indicators

{% code overflow="wrap" %}
```kusto
// Named pipe indicators
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "NamedPipeCreated"
| where PipeName matches regex @"\\\\\.\\pipe\\(MSSE-|status_|msagent_|postex_|mojo\.|demoagent_|\\w{8}-\\w{4}-\\w{4})"
| project Timestamp, DeviceName, PipeName, InitiatingProcessFileName, InitiatingProcessCommandLine

// Process injection
union DeviceEvents, DeviceProcessEvents
| where Timestamp > ago(7d)
| where ActionType in ("CreateRemoteThreadApiCall", "QueueUserApcRemoteApiCall", "SetThreadContextRemoteApiCall")
| project Timestamp, DeviceName, ActionType, FileName, InitiatingProcessFileName, ProcessCommandLine
```
{% endcode %}

#### Hunt for Mimikatz Activity

```kusto
DeviceProcessEvents
| where Timestamp > ago(7d)
| where ProcessCommandLine has_any (
    "sekurlsa::logonpasswords",
    "sekurlsa::wdigest", 
    "lsadump::sam",
    "lsadump::dcsync",
    "kerberos::golden",
    "privilege::debug",
    "token::elevate")
    or FileName =~ "mimikatz.exe"
    or SHA256 in ((known_mimikatz_hashes))
| project Timestamp, DeviceName, AccountName, FileName, ProcessCommandLine
```

#### Living Off the Land Detection

{% code overflow="wrap" %}
```kusto
DeviceProcessEvents
| where Timestamp > ago(24h)
| where 
    (FileName =~ "certutil.exe" and ProcessCommandLine has_any ("-urlcache", "-decode", "-encode"))
    or (FileName =~ "bitsadmin.exe" and ProcessCommandLine has_any ("/transfer", "/download"))
    or (FileName =~ "mshta.exe" and ProcessCommandLine has_any ("http://", "https://", "javascript:"))
    or (FileName =~ "regsvr32.exe" and ProcessCommandLine has_any ("/s", "/u", "/i:http"))
    or (FileName =~ "rundll32.exe" and ProcessCommandLine has_any ("javascript:", "http://", ".dll,"))
| project Timestamp, DeviceName, AccountName, FileName, ProcessCommandLine, InitiatingProcessFileName
```
{% endcode %}

***

## Response Actions & Remediation

### Immediate Containment Actions

<table><thead><tr><th width="200">Scenario</th><th width="201">Action</th><th>Method</th></tr></thead><tbody><tr><td><strong>Active Malware</strong></td><td>Isolate device</td><td>MDE ‚Üí Device page ‚Üí Isolate device</td></tr><tr><td><strong>Ransomware</strong></td><td>Network isolation</td><td>Isolate + disable network shares</td></tr><tr><td><strong>C2 Communication</strong></td><td>Block C2 IPs/domains</td><td>Prisma Access + MDE custom indicators</td></tr><tr><td><strong>Compromised Account</strong></td><td>Disable account</td><td>Entra ID + on-prem AD</td></tr><tr><td><strong>Malicious Email</strong></td><td>Purge from mailboxes</td><td>MDO ‚Üí Threat Explorer ‚Üí Soft/Hard delete</td></tr><tr><td><strong>Malicious File</strong></td><td>Block by hash</td><td>MDE ‚Üí Indicators ‚Üí Add file hash</td></tr></tbody></table>

### MDE Live Response Commands

#### Evidence Collection

```bash
# Connect to device via Live Response in MDE portal

# Collect running processes
processes

# Get network connections  
connections

# Collect file for analysis
getfile "C:\Users\user\AppData\Local\Temp\malware.exe"

# Get file information
fileinfo "C:\Users\user\AppData\Local\Temp\malware.exe"

# Run script for memory dump
run MemoryDump.ps1

# Get autoruns
run GetAutoruns.ps1
```

#### Remediation Commands

{% code overflow="wrap" %}
```bash
# Kill malicious process
remediate kill [PID]

# Quarantine file
remediate quarantine "C:\path\to\malware.exe"

# Remove scheduled task
remediate scheduledtask remove "MaliciousTask"

# Remove registry key
remediate registry delete "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "MaliciousValue"

# Undo isolation
unisolate
```
{% endcode %}

### Network Containment (Prisma Access)

<table><thead><tr><th width="183">Action</th><th>Location</th><th>Details</th></tr></thead><tbody><tr><td><strong>Block malicious URL</strong></td><td>URL Filtering ‚Üí Custom Categories</td><td>Add URL to block category</td></tr><tr><td><strong>Block C2 IP</strong></td><td>Security Policy ‚Üí External Dynamic Lists</td><td>Add IP to block list</td></tr><tr><td><strong>Block file hash</strong></td><td>Threat Prevention ‚Üí Antivirus</td><td>Add to custom signature</td></tr><tr><td><strong>Isolate user traffic</strong></td><td>GlobalProtect ‚Üí HIP Profiles</td><td>Quarantine non-compliant</td></tr></tbody></table>

### Post-Incident Remediation Checklist

#### Eradication

* \[ ] Remove all malware files from affected systems
* \[ ] Delete persistence mechanisms (registry, scheduled tasks, services)
* \[ ] Remove malicious accounts created by attacker
* \[ ] Clear cached credentials on affected systems
* \[ ] Reset passwords for compromised accounts
* \[ ] Revoke all sessions for affected users
* \[ ] Block all identified IOCs at all layers

#### Recovery

* \[ ] Restore systems from clean backups if needed
* \[ ] Rebuild compromised systems if necessary
* \[ ] Verify integrity of restored data
* \[ ] Re-enable disabled accounts after password reset
* \[ ] Remove device isolation in phases
* \[ ] Monitor recovered systems closely for 72 hours

#### Hardening

* \[ ] Patch exploited vulnerabilities
* \[ ] Review and tighten application control policies
* \[ ] Enable ASR rules relevant to attack technique
* \[ ] Update email filtering rules
* \[ ] Review firewall rules and network segmentation
* \[ ] Conduct user awareness training if phishing-based

***

## Quick Reference Cards

### Malware Analysis Checklist

<table><thead><tr><th width="110">Step</th><th width="226">Action</th><th>Tools</th></tr></thead><tbody><tr><td>1</td><td>Collect file hash (SHA256)</td><td>MDE, PowerShell</td></tr><tr><td>2</td><td>Check reputation</td><td>VirusTotal, MDE TI</td></tr><tr><td>3</td><td>Analyze strings</td><td>FLOSS, strings</td></tr><tr><td>4</td><td>Sandbox detonation</td><td>MDE Deep Analysis, Any.Run, Joe Sandbox</td></tr><tr><td>5</td><td>Review network IOCs</td><td>Sandbox report, Wireshark</td></tr><tr><td>6</td><td>Extract config</td><td>Malware-specific tools</td></tr><tr><td>7</td><td>Document TTPs</td><td>MITRE ATT&#x26;CK mapping</td></tr></tbody></table>

### File Hash Quick Check

```powershell
# Get SHA256 hash of a file
Get-FileHash -Algorithm SHA256 "C:\path\to\file.exe"

# Get multiple hashes
Get-FileHash -Algorithm SHA256 "C:\path\to\file.exe" | Select-Object Hash, Path
Get-FileHash -Algorithm MD5 "C:\path\to\file.exe" | Select-Object Hash

# Check file signature
Get-AuthenticodeSignature "C:\path\to\file.exe"
```

### Common Malware File Locations

| Location                     | Typical Use             |
| ---------------------------- | ----------------------- |
| `%TEMP%`                     | Initial payload drops   |
| `%APPDATA%`                  | User-level persistence  |
| `%LOCALAPPDATA%`             | User-level persistence  |
| `%PROGRAMDATA%`              | System-wide persistence |
| `C:\Users\Public`            | Shared access drops     |
| `%WINDIR%\Temp`              | System temp drops       |
| `%WINDIR%\Tasks`             | Scheduled task abuse    |
| Recycle Bin (`$Recycle.Bin`) | Hidden storage          |

### Attack Stage Indicators

<table><thead><tr><th width="123">Stage</th><th width="302">Indicators</th><th>Data Source</th></tr></thead><tbody><tr><td><strong>Delivery</strong></td><td>Phishing email, malicious download</td><td>EmailEvents, DeviceNetworkEvents</td></tr><tr><td><strong>Exploitation</strong></td><td>Vulnerability trigger, macro execution</td><td>DeviceEvents, DeviceProcessEvents</td></tr><tr><td><strong>Installation</strong></td><td>File drops, registry changes</td><td>DeviceFileEvents, DeviceRegistryEvents</td></tr><tr><td><strong>C2</strong></td><td>Beaconing, DNS queries</td><td>DeviceNetworkEvents</td></tr><tr><td><strong>Actions</strong></td><td>Data staging, lateral movement</td><td>DeviceFileEvents, DeviceLogonEvents</td></tr><tr><td><strong>Exfiltration</strong></td><td>Large transfers, cloud uploads</td><td>DeviceNetworkEvents, CloudAppEvents</td></tr></tbody></table>

***

## Escalation Matrix

### Severity Classification

<table><thead><tr><th width="128">Severity</th><th width="440">Criteria</th><th>Response Time</th></tr></thead><tbody><tr><td>üî¥ <strong>Critical</strong></td><td>Active ransomware, confirmed C2, data exfiltration in progress, wiper malware</td><td>Immediate - 15 min</td></tr><tr><td>üü† <strong>High</strong></td><td>Confirmed malware execution, lateral movement, credential theft tools</td><td>30 min - 1 hour</td></tr><tr><td>üü° <strong>Medium</strong></td><td>Suspicious execution blocked, potential malware, single endpoint</td><td>4 hours</td></tr><tr><td>üü¢ <strong>Low</strong></td><td>PUP detected, adware, blocked download attempt</td><td>Next business day</td></tr></tbody></table>

### Escalation Triggers

| Condition                         | Escalation Level                   |
| --------------------------------- | ---------------------------------- |
| >5 endpoints with same malware    | Tier 2 SOC                         |
| Any ransomware detection          | Tier 2 SOC + DFIR                  |
| Domain controller affected        | DFIR + Identity Team + Leadership  |
| Confirmed data exfiltration       | DFIR + Legal + Leadership          |
| Supply chain compromise suspected | DFIR + Leadership + External IR    |
| Critical business system affected | DFIR + Business Owner + Leadership |

### Communication Templates

#### Initial Notification (Internal)

```bash
SECURITY INCIDENT NOTIFICATION

Severity: [Critical/High/Medium/Low]
Time Detected: [Timestamp UTC]
Affected Systems: [Count and list]
Malware Family: [If known]
Current Status: [Investigating/Contained/Eradicated]

Summary:
[Brief description of what was detected]

Immediate Actions Taken:
- [Action 1]
- [Action 2]

Next Steps:
- [Planned action 1]
- [Planned action 2]

SOC Contact: [Name/Number]
```

***

## MITRE ATT\&CK Mapping

### Initial Access

<table><thead><tr><th width="218">Technique</th><th width="131">ID</th><th>Detection</th><th>KQL Table</th></tr></thead><tbody><tr><td>Phishing: Attachment</td><td>T1566.001</td><td>Malicious attachment detected</td><td>EmailAttachmentInfo</td></tr><tr><td>Phishing: Link</td><td>T1566.002</td><td>Malicious URL clicked</td><td>UrlClickEvents</td></tr><tr><td>Drive-by Compromise</td><td>T1189</td><td>Browser exploitation</td><td>DeviceProcessEvents</td></tr><tr><td>Supply Chain</td><td>T1195</td><td>Compromised software</td><td>DeviceFileEvents</td></tr><tr><td>External Remote Services</td><td>T1133</td><td>VPN/RDP compromise</td><td>DeviceLogonEvents</td></tr></tbody></table>

### Execution

<table><thead><tr><th>Technique</th><th width="123">ID</th><th>Detection</th><th>KQL Table</th></tr></thead><tbody><tr><td>PowerShell</td><td>T1059.001</td><td>Encoded commands, download cradles</td><td>DeviceProcessEvents</td></tr><tr><td>Command Shell</td><td>T1059.003</td><td>Suspicious cmd.exe usage</td><td>DeviceProcessEvents</td></tr><tr><td>Windows Script Host</td><td>T1059.005</td><td>VBS/JS execution</td><td>DeviceProcessEvents</td></tr><tr><td>Mshta</td><td>T1218.005</td><td>HTA execution</td><td>DeviceProcessEvents</td></tr><tr><td>Regsvr32</td><td>T1218.010</td><td>Proxy execution</td><td>DeviceProcessEvents</td></tr><tr><td>Rundll32</td><td>T1218.011</td><td>DLL side-loading</td><td>DeviceProcessEvents</td></tr></tbody></table>

### Persistence

<table><thead><tr><th>Technique</th><th width="143">ID</th><th>Detection</th><th>KQL Table</th></tr></thead><tbody><tr><td>Registry Run Keys</td><td>T1547.001</td><td>Run key modification</td><td>DeviceRegistryEvents</td></tr><tr><td>Scheduled Task</td><td>T1053.005</td><td>Task creation</td><td>DeviceEvents</td></tr><tr><td>Services</td><td>T1543.003</td><td>Service installation</td><td>DeviceEvents</td></tr><tr><td>WMI Subscription</td><td>T1546.003</td><td>WMI filter/consumer</td><td>DeviceEvents</td></tr><tr><td>Boot/Logon Scripts</td><td>T1037</td><td>Startup script</td><td>DeviceRegistryEvents</td></tr></tbody></table>

### Defense Evasion

| Technique              | ID    | Detection              | KQL Table           |
| ---------------------- | ----- | ---------------------- | ------------------- |
| Process Injection      | T1055 | Remote thread creation | DeviceEvents        |
| Masquerading           | T1036 | Renamed executables    | DeviceProcessEvents |
| Obfuscated Files       | T1027 | Encoded payloads       | DeviceProcessEvents |
| Disable Security Tools | T1562 | AV/EDR tampering       | DeviceEvents        |
| Indicator Removal      | T1070 | Log clearing           | DeviceEvents        |

### Credential Access

| Technique          | ID        | Detection              | KQL Table            |
| ------------------ | --------- | ---------------------- | -------------------- |
| LSASS Dump         | T1003.001 | LSASS access           | DeviceEvents         |
| SAM Dump           | T1003.002 | Registry SAM access    | DeviceRegistryEvents |
| Credential Dumping | T1003     | Mimikatz execution     | DeviceProcessEvents  |
| Keylogging         | T1056.001 | Keylogger installation | DeviceEvents         |

### Command & Control

| Technique         | ID        | Detection         | KQL Table           |
| ----------------- | --------- | ----------------- | ------------------- |
| HTTP/HTTPS        | T1071.001 | Web traffic to C2 | DeviceNetworkEvents |
| DNS               | T1071.004 | DNS tunneling     | DeviceNetworkEvents |
| Non-Standard Port | T1571     | Unusual ports     | DeviceNetworkEvents |
| Encrypted Channel | T1573     | SSL/TLS to C2     | DeviceNetworkEvents |

### Exfiltration

| Technique       | ID    | Detection             | KQL Table           |
| --------------- | ----- | --------------------- | ------------------- |
| Exfil Over C2   | T1041 | Large uploads to C2   | DeviceNetworkEvents |
| Exfil Over Web  | T1567 | Cloud storage uploads | CloudAppEvents      |
| Automated Exfil | T1020 | Scheduled transfers   | DeviceNetworkEvents |

***

## Appendix: Useful Commands

### PowerShell Investigation

{% code overflow="wrap" %}
```powershell
# Get running processes with command line
Get-CimInstance Win32_Process | Select-Object ProcessId, Name, CommandLine

# Find processes by name
Get-Process -Name "powershell" | Select-Object Id, ProcessName, Path, StartTime

# Get network connections
Get-NetTCPConnection | Where-Object {$_.State -eq "Established"} | Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, OwningProcess

# Get DNS cache
Get-DnsClientCache | Select-Object Entry, Data, TimeToLive

# Check scheduled tasks
Get-ScheduledTask | Where-Object {$_.State -eq "Ready"} | Select-Object TaskName, TaskPath, State

# Review services
Get-Service | Where-Object {$_.Status -eq "Running"} | Select-Object Name, DisplayName, StartType

# Check startup items
Get-CimInstance Win32_StartupCommand | Select-Object Name, Command, Location

# Get recently modified files
Get-ChildItem -Path C:\Users -Recurse -File | Where-Object {$_.LastWriteTime -gt (Get-Date).AddHours(-24)} | Select-Object FullName, LastWriteTime

# Check for unsigned executables
Get-ChildItem -Path "C:\Users" -Recurse -Include *.exe | Get-AuthenticodeSignature | Where-Object {$_.Status -ne "Valid"}
```
{% endcode %}

### MDE Advanced Hunting in PowerShell

```powershell
# Connect to Security Center
Connect-MicrosoftDefender

# Run advanced hunting query
$query = @"
DeviceProcessEvents
| where Timestamp > ago(24h)
| where FileName =~ "powershell.exe"
| where ProcessCommandLine has "-enc"
| project Timestamp, DeviceName, ProcessCommandLine
"@

Invoke-MDATPQuery -Query $query
```

### Network Analysis

{% code overflow="wrap" %}
```powershell
# Get established connections with process names
Get-NetTCPConnection -State Established | ForEach-Object {
    $process = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
    [PSCustomObject]@{
        LocalAddress = $_.LocalAddress
        LocalPort = $_.LocalPort
        RemoteAddress = $_.RemoteAddress
        RemotePort = $_.RemotePort
        ProcessName = $process.Name
        ProcessPath = $process.Path
    }
}

# Check for listening ports
Get-NetTCPConnection -State Listen | Select-Object LocalAddress, LocalPort, OwningProcess

# DNS queries from event log
Get-WinEvent -LogName "Microsoft-Windows-DNS-Client/Operational" -MaxEvents 100 | Select-Object TimeCreated, Message
```
{% endcode %}

### Memory Analysis Prep

{% code overflow="wrap" %}
```powershell
# Create memory dump using Windows built-in
# Requires procdump or similar tool
.\procdump.exe -ma lsass.exe lsass.dmp

# Or use PowerShell with comsvcs.dll (requires elevation)
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).Id C:\temp\lsass.dmp full
```
{% endcode %}

### Evidence Collection Script

{% code overflow="wrap" %}
```powershell
# Quick triage script
$outputPath = "C:\IR_Evidence_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $outputPath -Force

# System info
systeminfo > "$outputPath\systeminfo.txt"

# Running processes
Get-Process | Export-Csv "$outputPath\processes.csv" -NoTypeInformation

# Network connections
Get-NetTCPConnection | Export-Csv "$outputPath\network.csv" -NoTypeInformation

# Services
Get-Service | Export-Csv "$outputPath\services.csv" -NoTypeInformation

# Scheduled tasks
Get-ScheduledTask | Export-Csv "$outputPath\scheduledtasks.csv" -NoTypeInformation

# Recent files
Get-ChildItem -Path C:\Users -Recurse -File -ErrorAction SilentlyContinue | 
    Where-Object {$_.LastWriteTime -gt (Get-Date).AddDays(-7)} | 
    Export-Csv "$outputPath\recentfiles.csv" -NoTypeInformation

# Compress for collection
Compress-Archive -Path $outputPath -DestinationPath "$outputPath.zip"
```
{% endcode %}

***

> ‚ö†Ô∏è **Important:** This runbook should be tested regularly through tabletop exercises and updated after each significant incident to incorporate lessons learned and emerging malware techniques.
